%%{init: {'theme':'base','themeVariables':{ 'primaryColor':'#ff8b00','edgeLabelBackground':'#ffffff','tertiaryColor':'#fef3c7'}}}%%

stateDiagram-v2
title: SM-04.02 — Streaming Payout Lifecycle (C2-04 Treasury & Funding)

[*] --> OPEN : StreamOpened (DDD EVT 46)
note right of OPEN
  Initialize payout stream:
  • streamId, beneficiary, schedule
  • asset, rate, cap, escrowRef
  • policy & audit context
end note

OPEN --> ACTIVE : FundingAuthorized
note right of ACTIVE
  Disbursement ticks per schedule
  Escrow balance decrements
  Metrics updated periodically
end note

%% ===== Operating transitions =====
ACTIVE --> PAUSED : StreamPaused (DDD EVT 47)
PAUSED --> ACTIVE : StreamResumed (DDD EVT 48)

ACTIVE --> ADJUSTING : UpdateRequested
ADJUSTING --> ACTIVE : UpdateApplied

ACTIVE --> CLOSED : StreamClosed normal completion (DDD EVT 49)
PAUSED --> CLOSED : StreamClosed policy closure (DDD EVT 49)

%% ===== Exceptional paths =====
ACTIVE --> BLOCKED : RiskThresholdBreach detected by Security
BLOCKED --> PAUSED : PauseApplied
BLOCKED --> CLOSED : StreamTerminated critical incident

ACTIVE --> FAILED : TransferError / EscrowDepleted
PAUSED --> FAILED : ResumeError
FAILED --> CLOSED : FailureLogged (DDD EVT 50)

%% ===== Cancellations =====
OPEN --> CANCELLED : CancelRequested
CANCELLED --> CLOSED : Cancelled

%% ===== Terminal =====
CLOSED --> [*]

%% ===== Styling =====
classDef core fill:#ff8b00,stroke:#333,color:#fff,font-weight:bold;
class OPEN,ACTIVE,PAUSED,ADJUSTING,BLOCKED,FAILED,CANCELLED,CLOSED core;