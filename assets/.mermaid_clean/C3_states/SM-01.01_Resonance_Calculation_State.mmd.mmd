%%{init: {'theme':'base','themeVariables':{ 'primaryColor':'#ff8b00','edgeLabelBackground':'#ffffff','tertiaryColor':'#fef3c7'}}}%%

stateDiagram-v2
title: SM-01.01 — Resonance Calculation State (C2-01 Resonance Service)

[*] --> VALIDATE_INPUTS : ResonanceRequested (DDD EVT 01)
note right of VALIDATE_INPUTS
  Validate schema, source, and integrity
  Inputs: contribution vector, alignment signal
end note

VALIDATE_INPUTS --> CALCULATE_RESONANCE : InputValidated
note right of CALCULATE_RESONANCE
  Compute R = I × A × e^(−λΔt)
  Store temporary result and metadata
end note

CALCULATE_RESONANCE --> UPDATE_METRICS : ResonanceUpdated (DDD EVT 02)
note right of UPDATE_METRICS
  Emit resonance sample to Metrics (C2-07)
  Forward weighted output to SRI Engine
end note

CALCULATE_RESONANCE --> ANOMALY_CHECK : compute anomalyScore()
note right of ANOMALY_CHECK
  Detect abnormal patterns or oscillations
  Trigger alerts if deviation > σ threshold
end note

ANOMALY_CHECK --> FLAG_ANOMALY : AnomalyDetected (DDD EVT 03)
ANOMALY_CHECK --> UPDATE_METRICS : NormalSignal

FLAG_ANOMALY --> REVIEW : Escalate to Governance / Ethics
note right of REVIEW
  Feed anomaly context to Ethics (C2-08)
  and Governance (C2-03) for oversight
end note

UPDATE_METRICS --> [*] : MetricsPublished
REVIEW --> [*] : CaseClosed

%% =========== Styling ===========
classDef core fill:#ff8b00,stroke:#333,color:#fff,font-weight:bold;
class VALIDATE_INPUTS,CALCULATE_RESONANCE,ANOMALY_CHECK,UPDATE_METRICS,FLAG_ANOMALY,REVIEW core;