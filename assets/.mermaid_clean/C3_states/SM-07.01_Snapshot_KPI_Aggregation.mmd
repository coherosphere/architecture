%%{init: {'theme':'base','themeVariables':{ 'primaryColor':'#ff8b00','edgeLabelBackground':'#ffffff','tertiaryColor':'#fef3c7'}}}%%
stateDiagram-v2
title: SM-07.01 — Snapshot & KPI Aggregation (C2-07 Metrics / Analytics)

[*] --> SNAPSHOT_INIT : SnapshotStarted (DDD EVT 70)
note right of SNAPSHOT_INIT
  Initialize aggregation window:
  • wall-clock or governance-driven snapshot
  • bind ParamVersion (λ, α, thresholds)
  • allocate run-id for auditability
end note

SNAPSHOT_INIT --> LOAD_INPUTS : WindowBound
note right of LOAD_INPUTS
  Fetch inputs from services:
  • PoC CP/W deltas (C2-02)
  • Resonance samples (C2-01)
  • Treasury payouts & reserves (C2-04)
  • Governance decisions (C2-03)
  • Hub/project signals (C2-06)
end note

LOAD_INPUTS --> COMPUTE_FEATURES : InputsValidated
note right of COMPUTE_FEATURES
  Build feature store:
  • rolling sums / EMA / decay transforms
  • outlier clipping & normalization
  • join by canonical ids
end note

COMPUTE_FEATURES --> COMPUTE_SRI : FeaturesReady
note right of COMPUTE_SRI
  Compute Systemic Resonance Index (SRI):
  • aggregate R across domains
  • weighting & alignment factors
  • produce SRI_t and deltas
end note

COMPUTE_SRI --> AGGREGATE_KPIS : SRIComputed (DDD EVT 71)
note right of AGGREGATE_KPIS
  Aggregate KPIs:
  • CP_i, W_i, project A_j, funding stats
  • coherence trends & alerts
end note

AGGREGATE_KPIS --> PUBLISH : KPIUpdated (DDD EVT 72)
note right of PUBLISH
  Publish to:
  • UI (C2-12) — dashboards / heatmaps
  • Gov (C2-03) — decision support
  • Treasury (C2-04) — rebalancing
  • Ethics (C2-08) — coherence signals
end note

PUBLISH --> [*] : SnapshotClosed

%% ---- Integrity / reconciliation paths ----
LOAD_INPUTS --> GAP_DETECTED : MissingInputs / HashMismatch
GAP_DETECTED --> RECONCILE : BackfillRequested
RECONCILE --> LOAD_INPUTS : BackfillCompleted

COMPUTE_FEATURES --> REVIEW : AnomalyDetected
REVIEW --> COMPUTE_FEATURES : ClearedByReview
REVIEW --> FAILED : IntegrityBreach

PUBLISH --> RETRY : PublishError
RETRY --> PUBLISH : PublishRetried

FAILED --> [*] : SnapshotFailed

%% ===== Styling =====
classDef core fill:#ff8b00,stroke:#333,color:#fff,font-weight:bold;
class SNAPSHOT_INIT,LOAD_INPUTS,COMPUTE_FEATURES,COMPUTE_SRI,AGGREGATE_KPIS,PUBLISH,GAP_DETECTED,RECONCILE,REVIEW,RETRY,FAILED core;
