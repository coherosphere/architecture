%%{init: {'theme':'base','themeVariables':{ 'primaryColor':'#ff8b00','edgeLabelBackground':'#ffffff','tertiaryColor':'#fef3c7'}}}%%

stateDiagram-v2
title: SM-06.01 — Hub Sync State (C2-06 Local Hub / Federation)

[*] --> OUT_OF_SYNC : SyncRequested (DDD EVT 60)
note right of OUT_OF_SYNC
  Local hub detects divergence from federation:  
  • stale CRDT frame  
  • missing contributions or metrics  
  • network topology change  
end note

OUT_OF_SYNC --> FETCH_REMOTE : BeginSync
note right of FETCH_REMOTE
  Retrieve latest CRDT vector clocks and state diffs  
  from federation peers (P2P)  
end note

FETCH_REMOTE --> MERGE : FrameDownloaded
note right of MERGE
  Apply CRDT merge function  
  Resolve conflicts deterministically  
  Ensure convergence on shared state
end note

MERGE --> VALIDATE : MergeCompleted
note right of VALIDATE
  Run schema + hash integrity checks  
  Validate contribution and governance deltas  
  Verify signatures from remote hubs  
end note

VALIDATE --> SYNCED : SyncConfirmed (DDD EVT 61)
note right of SYNCED
  Federation state consistent  
  Metrics & proposals aligned with global ledger  
end note

SYNCED --> [*]

%% ---- Exceptional paths ----
FETCH_REMOTE --> FAILED : NetworkTimeout / AuthError
MERGE --> FAILED : ConflictUnresolved
VALIDATE --> FAILED : HashMismatch / SignatureInvalid
FAILED --> RETRY : RetryScheduled
RETRY --> OUT_OF_SYNC : RetrySync

%% ---- Maintenance / background ----
SYNCED --> OUT_OF_SYNC : PeriodicSync / ParamChange
OUT_OF_SYNC --> DEGRADED : HubOffline / LatencyHigh
DEGRADED --> [*] : EscalatedToOps

%% ===== Styling =====
classDef core fill:#ff8b00,stroke:#333,color:#fff,font-weight:bold;
class OUT_OF_SYNC,FETCH_REMOTE,MERGE,VALIDATE,SYNCED,FAILED,RETRY,DEGRADED core;