%%{init: {'theme':'neutral','themeVariables':{ 'sequenceNumberColor':'#444'}}}%%
sequenceDiagram
autonumber

actor S as Steward / SRE (C1-02)

box #ff8b00 Core Services
  participant SEC as C2-10 Security & Audit
  participant TRE as C2-04 Treasury & Funding
end


%% === Detection ===
S ->> SEC: Review risk dashboard (policy thresholds)
SEC ->> SEC: Evaluate SIEM signals and anomaly scores

alt Threshold breached
  SEC -->> SEC: RiskThresholdBreachDetected (DDD-EVT-83)
  SEC -->> SEC: Guardrails require stream pause
else No breach
  SEC -->> SEC: Continue monitoring (no action)
end

%% spacer
%% --------------------------------------------

%% === Pause Flow ===
SEC ->> SEC: Confirm breach and check active streams

alt Active streams found
  SEC ->> TRE: pauseStream(streamId, reason, evidenceRef)
  TRE ->> TRE: Halt disbursement on escrow/stream
  TRE -->> SEC: streamPaused(ack)
  SEC -->> SEC: FundingStreamPaused (DDD-EVT-84)
  SEC -->> TRE: Record pause context (evidenceRef)
else No active streams
  SEC -->> SEC: FundingPauseRecorded (audit-only)
end

%% spacer
%% --------------------------------------------

%% === Steward Acknowledgement ===
S ->> SEC: Acknowledge pause (ticket linked)
SEC -->> S: Status paused, evidence, next review window

%% spacer
%% --------------------------------------------

%% === Monitoring Loop ===
loop Periodic review
  SEC ->> SEC: Reassess signals and mitigations
  alt Risk cleared
    SEC -->> SEC: RiskCleared (DDD-EVT-85)
    SEC ->> TRE: resumeStream(streamId, rationale)
    TRE ->> TRE: Resume disbursement
    TRE -->> SEC: streamResumed(ack)
    SEC -->> SEC: FundingStreamResumed (DDD-EVT-86)
  else Still at risk
    SEC -->> SEC: RetainEvidence + keep paused
  end
end

%% spacer
%% --------------------------------------------

%% === Completion ===
SEC -->> S: Final status (resumed or escalation)
SEC -->> SEC: All actions audited (hashes/signatures)