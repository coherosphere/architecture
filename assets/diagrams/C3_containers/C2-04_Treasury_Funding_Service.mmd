%%{init: {'theme':'base','themeVariables':{ 'fontFamily':'Inter,Arial', 'primaryColor':'#ff8b00','lineColor':'#334155'}}}%%
flowchart LR
%%{init: {'theme':'base','themeVariables':{ 'fontFamily':'Inter,Arial', 'primaryColor':'#ff8b00','lineColor':'#334155'}}}%%
flowchart LR
  %% --- Coherosphere CI Theme ---
  classDef container fill:#111827,stroke:#111827,color:#ffffff,font-weight:bold;
  classDef compute fill:#ff8b00,stroke:#333333,color:#ffffff;
  classDef control fill:#fde68a,stroke:#b45309,color:#1f2937;
  classDef worker fill:#fb923c,stroke:#7c2d12,color:#1f2937;
  classDef store fill:#0ea5e9,stroke:#075985,color:#ffffff;
  classDef event fill:#22c55e,stroke:#065f46,color:#083344;
  classDef risk fill:#ef4444,stroke:#7f1d1d,color:#ffffff;
  classDef ext fill:#e5e7eb,stroke:#9ca3af,color:#111827;
  classDef ui fill:#8b5cf6,stroke:#4c1d95,color:#ffffff;
  linkStyle default stroke:#334155,stroke-width:2px;

  %% ===== Container & Components (C2-04 â†’ C3-04.xx) =====
  subgraph TRE["C2-04 Treasury & Funding Service"]
    class TRE container
    QF["C3-04.01 Quadratic Funding Engine"]:::compute
    PAY["C3-04.02 Payout Orchestrator"]:::control
    RES["C3-04.03 Reserve Manager"]:::control
    RISK["C3-04.04 Compliance & Risk Checks"]:::risk
    ESCROW["C3-04.05 Escrow Processor"]:::worker
    CHAIN["C3-04.06 On-Chain Adapter (Tx Bridge)"]:::control
    TDB["C3-04.07 Treasury Ledger / DB"]:::store
    PUB["C3-04.08 Event Publisher (Funding Signals)"]:::event
  end

  %% ===== Internal flow =====
  QF --> PAY --> ESCROW --> CHAIN
  RES --> PAY
  RISK -. verify .-> PAY
  PAY --> TDB
  TDB --> PUB

  %% ===== External context links =====
  GOV["C2-03 Governance Service"]:::ext --> QF
  POC["C2-02 PoC Service"]:::ext --> QF
  ID["C2-05 Identity (PoCI)"]:::ext --> RISK
  PUB --> MET["C2-07 Metrics / Analytics"]:::ext
  SEC["C2-10 Security & Audit Layer"]:::ext --> RISK
  CHAIN --> BTC["C1-06 Bitcoin / Hard Asset Layer"]:::ext
  PUB --> GOV
  PUB --> HUB["C2-06 Local Hub / Federation"]:::ext
