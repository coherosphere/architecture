%%{init: {'theme':'base','themeVariables':{ 'fontFamily':'Inter,Arial', 'primaryColor':'#ff8b00','lineColor':'#334155'}}}%%
flowchart LR
%%{init: {'theme':'base','themeVariables':{ 'fontFamily':'Inter,Arial', 'primaryColor':'#ff8b00','lineColor':'#334155'}}}%%
flowchart LR
  %% --- Coherosphere CI Theme ---
  classDef container fill:#111827,stroke:#111827,color:#ffffff,font-weight:bold;
  classDef compute fill:#ff8b00,stroke:#333333,color:#ffffff;
  classDef control fill:#fde68a,stroke:#b45309,color:#1f2937;
  classDef worker fill:#fb923c,stroke:#7c2d12,color:#1f2937;
  classDef store fill:#0ea5e9,stroke:#075985,color:#ffffff;
  classDef event fill:#22c55e,stroke:#065f46,color:#083344;
  classDef risk fill:#ef4444,stroke:#7f1d1d,color:#ffffff;
  classDef ext fill:#e5e7eb,stroke:#9ca3af,color:#111827;
  classDef ui fill:#8b5cf6,stroke:#4c1d95,color:#ffffff;
  linkStyle default stroke:#334155,stroke-width:2px;

  %% ===== Container & Components (C2-07 â†’ C3-07.xx) =====
  subgraph MET["C2-07 Resonance Metric Stack / Analytics"]
    class MET container
    ING["C3-07.01 Stream Ingest (Events & Signals)"]:::control
    KPI["C3-07.02 KPI Aggregator (A_j, R_j, CP_i, W_i)"]:::compute
    SRI["C3-07.03 Systemic Resonance Index (SRI Engine)"]:::compute
    FEAT["C3-07.04 Feature Store (Derived Metrics)"]:::store
    ANOM["C3-07.05 Anomaly Detector"]:::risk
    DASH["C3-07.06 Dashboard Feed / Stream API"]:::event
    MDB["C3-07.07 Metrics Data Store"]:::store
    SNAP["C3-07.08 Batch Snapshot Worker"]:::worker
  end

  %% ===== Internal flows =====
  ING --> KPI --> SRI --> DASH
  KPI --> FEAT
  KPI --> MDB
  SRI --> MDB
  SNAP --> KPI
  ANOM -. alerts .-> KPI

  %% ===== External context =====
  RS["C2-01 Resonance Service"]:::ext --> ING
  POC["C2-02 PoC Service"]:::ext --> ING
  GOV["C2-03 Governance"]:::ext --> ING
  TRE["C2-04 Treasury"]:::ext --> ING
  HUB["C2-06 Local Hubs"]:::ext --> ING
  ETH["C2-08 Manifesto & Ethics Guard"]:::ext --> SRI
  MET --> SEC["C2-10 Security & Audit"]:::ext
  DASH --> UI["C2-12 Resonance Board / UI"]:::ui
