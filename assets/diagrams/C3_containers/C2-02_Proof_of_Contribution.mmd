%%{init: {'theme':'base','themeVariables':{ 'fontFamily':'Inter,Arial', 'primaryColor':'#ff8b00','lineColor':'#334155'}}}%%
flowchart LR
  %% --- Coherosphere CI Theme ---
  classDef container fill:#111827,stroke:#111827,color:#ffffff,font-weight:bold;
  classDef compute fill:#ff8b00,stroke:#333333,color:#ffffff;
  classDef control fill:#fde68a,stroke:#b45309,color:#1f2937;
  classDef worker fill:#fb923c,stroke:#7c2d12,color:#1f2937;
  classDef store fill:#0ea5e9,stroke:#075985,color:#ffffff;
  classDef event fill:#22c55e,stroke:#065f46,color:#083344;
  classDef risk fill:#ef4444,stroke:#7f1d1d,color:#ffffff;
  classDef ext fill:#e5e7eb,stroke:#9ca3af,color:#111827;
  classDef ui fill:#8b5cf6,stroke:#4c1d95,color:#ffffff;
  linkStyle default stroke:#334155,stroke-width:2px;

  %% ===== Container & Components (C2-02 → C3-02.xx) =====
  subgraph POC["C2-02 Proof-of-Contribution (PoC) Service"]
    class POC container
    API["C3-02.01 API Controller"]:::control
    AUTHZ["C3-02.02 Schema & Policy Guard"]:::control
    DEDUP["C3-02.03 Contribution Normalizer"]:::control
    VAL["C3-02.04 Alignment & Impact Intake"]:::compute
    TIME["C3-02.05 Time Decay Updater (λ)"]:::compute
    CPACC["C3-02.06 Contribution Accumulator (CP)"]:::compute
    WMAP["C3-02.07 Voting Weight Mapper (W = CP^α)"]:::compute
    LEDGER["C3-02.08 PoC Ledger (Immutable)"]:::store
    SNAP["C3-02.09 Snapshotter & Recompute Worker"]:::worker
    RECON["C3-02.10 Reconciliation & Oracles"]:::control
    SYBIL["C3-02.11 Sybil / Spam Guard"]:::risk
    PUB["C3-02.12 Events & Exports"]:::event
  end

  %% ===== Main internal flow =====
  API --> AUTHZ --> DEDUP --> VAL
  VAL --> TIME --> CPACC --> WMAP
  DEDUP --> LEDGER
  TIME --> LEDGER
  CPACC --> LEDGER
  WMAP --> LEDGER
  RECON --> SNAP
  SNAP --> TIME
  SNAP --> CPACC
  SNAP --> WMAP
  LEDGER --> PUB

  %% ===== External context links =====
  USER["C1-02 Member / Contributor"]:::ext --> API
  HUB["C2-06 Local Hub Adapter"]:::ext --> API
  UI["C2-12 Resonance Board / UI"]:::ui --> API
  ID["C2-05 Identity (PoCI)"]:::ext --> AUTHZ
  ID --> SYBIL
  ETH["C2-08 Manifesto & Ethics Guard"]:::ext --> VAL
  ETH --> RECON
  VAL --> RS["C2-01 Resonance Service"]:::ext
  PUB --> GOV["C2-03 Governance"]:::ext
  PUB --> MET["C2-07 Metrics / SRI"]:::ext
  LEDGER --> SEC["C2-10 Security & Audit"]:::ext
  EXT["External Oracles / Repos"]:::ext --> RECON
