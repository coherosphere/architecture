%%{init: {'theme':'base','themeVariables':{ 'fontFamily':'Inter,Arial', 'primaryColor':'#ff8b00','lineColor':'#334155'}}}%%
stateDiagram-v2
%%{init: {'theme':'base','themeVariables':{ 'fontFamily':'Inter,Arial', 'primaryColor':'#ff8b00','lineColor':'#334155'}}}%%
stateDiagram-v2
%%{init: {'theme':'base','themeVariables':{ 'primaryColor':'#ff8b00','edgeLabelBackground':'#ffffff','tertiaryColor':'#fef3c7'}}}%%
stateDiagram-v2
title: SM-02.01 - Contribution Lifecycle (C2-02 Proof-of-Contribution)

[*] --> NORMALIZE : ContributionSubmitted
note right of NORMALIZE
  Canonicalize payload (dedup, idempotency)
  Build canonical contribution hash and refs
end note

NORMALIZE --> SYBIL_CHECK : Normalized
note right of SYBIL_CHECK
  Rate limits, graph heuristics, reputation gates
  Uses PoCI (C2-05) & Security signals (C2-10)
end note

SYBIL_CHECK --> REJECTED : SybilFlagged
SYBIL_CHECK --> VALIDATE : PassedSybilChecks

VALIDATE --> INTAKE_ALIGN : SchemaValid
VALIDATE --> REJECTED : SchemaInvalid
note right of VALIDATE
  JSON Schema, policy guard, size caps
  Required fields present
end note

INTAKE_ALIGN --> SCORE_IMPACT : AlignmentChecked
note right of INTAKE_ALIGN
  Ethics preflight (C2-08)
  Rubric mapping, human/AI adapters
end note

SCORE_IMPACT --> UPDATE_CP : ImpactScored
note right of SCORE_IMPACT
  Map impact to resonance inputs
  Prepare CP increment
end note

UPDATE_CP --> LEDGER : CPUpdated
note right of UPDATE_CP
  W_i = (CP_i)^alpha with 0 < alpha < 1
  Emit PoC events for Metrics (C2-07)
end note

LEDGER --> CONFIRMED : LedgerCommitted
note right of LEDGER
  Append-only event store, snapshot policies
  Reconciliation with external oracles (optional)
end note

%% ---- Exceptions & reviews ----
SCORE_IMPACT --> REVIEW : AnomalyDetected
REVIEW --> CONFIRMED : ClearedByReview
REVIEW --> REJECTED : RejectedByReview

REJECTED --> [*]
CONFIRMED --> [*]

%% =========== Styling ===========
classDef core fill:#ff8b00,stroke:#333,color:#fff,font-weight:bold;
class NORMALIZE,SYBIL_CHECK,VALIDATE,INTAKE_ALIGN,SCORE_IMPACT,UPDATE_CP,LEDGER,REVIEW,REJECTED,CONFIRMED core;
