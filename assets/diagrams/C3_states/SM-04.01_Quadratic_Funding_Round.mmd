%%{init: {'theme':'base','themeVariables':{ 'fontFamily':'Inter,Arial', 'primaryColor':'#ff8b00','lineColor':'#334155'}}}%%
stateDiagram-v2
%%{init: {'theme':'base','themeVariables':{ 'fontFamily':'Inter,Arial', 'primaryColor':'#ff8b00','lineColor':'#334155'}}}%%
stateDiagram-v2
%%{init: {'theme':'base','themeVariables':{ 'primaryColor':'#ff8b00','edgeLabelBackground':'#ffffff','tertiaryColor':'#fef3c7'}}}%%
stateDiagram-v2
title: SM-04.01 - Quadratic Funding Round (C2-04 Treasury & Funding)

[*] --> SETUP : RoundOpened (DDD EVT 41)
note right of SETUP
  Initialize round:
  · funding pool created
  · governance parameters (q, matchCap, duration)
  · project registry snapshot
end note

SETUP --> ACCEPTING_DONATIONS : SetupCompleted
note right of ACCEPTING_DONATIONS
  Contributors donate to registered projects
  Donations logged with identity & PoC weighting
end note

ACCEPTING_DONATIONS --> MATCHING_CALC : RoundClosed
note right of MATCHING_CALC
  Compute quadratic match per project:
  match = (Σ√donations)² − Σ(donations)
  Requires normalization & Sybil weighting
end note

MATCHING_CALC --> REVIEW : MatchingComputed (DDD EVT 42)
note right of REVIEW
  Treasury + Ethics Guard verify fairness
  Potential anomalies or manipulations flagged
end note

REVIEW --> ADJUST : AdjustmentRequired
ADJUST --> REVIEWED : AdjustmentApplied
REVIEW --> APPROVED : Approved (DDD EVT 43)
REVIEWED --> APPROVED : ApprovedAfterAdjustment (DDD EVT 43)

APPROVED --> PAYOUT : FundingAllocated (DDD EVT 44)
note right of PAYOUT
  Execute payouts:
  · stream / escrow smart contracts
  · SRI-weighted distribution
  · audit proof attached
end note

PAYOUT --> CLOSED : RoundClosed (DDD EVT 45)
CLOSED --> [*]

%% ---- Exceptional paths ----
MATCHING_CALC --> ABORTED : Error / IntegrityFail
APPROVED --> ABORTED : TreasuryCapExceeded / PolicyChange
ABORTED --> [*] : RoundAborted

%% ===== Styling =====
classDef core fill:#ff8b00,stroke:#333,color:#fff,font-weight:bold;
class SETUP,ACCEPTING_DONATIONS,MATCHING_CALC,REVIEW,ADJUST,REVIEWED,APPROVED,PAYOUT,CLOSED,ABORTED core;
